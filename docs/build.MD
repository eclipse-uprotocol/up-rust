# ğŸ—ï¸ Build Process

## ğŸ“˜ Overview

The [`build.rs`](./../build.rs) file is a special build script that is executed automatically by Cargo during the following commands:

- `cargo build`
- `cargo test`
- `cargo run`

---

## ğŸ” Execution Flow

```text
cargo build / test / run
        â¬‡ï¸
Cargo checks for a build.rs file in the root directory
        â¬‡ï¸
If found, it runs the main() function inside build.rs
        â¬‡ï¸
Once build.rs finishes, Cargo proceeds with:
   - Running main() if it's a binary (`bin`) package
   - Running tests if it's a library (`lib`) package
```

## ğŸ”§ Whatâ€™s Inside `build.rs`

The `build.rs` file is a Rust build script that runs **before** your crate is compiled.

Hereâ€™s what it does at a high level:

- âœ… **Specifies `.proto` files** that define the uProtocol data models (e.g., `uuid.proto`, `uri.proto`, `umessage.proto`, etc.)

- âš™ï¸ **Uses `protobuf_codegen`** to generate Rust code from those `.proto` files

- ğŸ“¦ **Outputs** the generated code to the crateâ€™s output directory (`OUT_DIR`)

- ğŸ”„ Uses a **vendored `protoc` compiler** (via `protoc-bin-vendored`) instead of relying on a system-installed version

- ğŸ§© Conditionally includes optional features like:
  - `udiscovery`
  - `usubscription`
  - `utwin`
  - `cloudevents` (generates separately)

This script ensures that whenever you build the crate, the Protobuf definitions are always up-to-date and compiled into Rust.

---

## ğŸ§­ build.rs Execution Flow Diagram

```bash
cargo build / test / run
        â¬‡ï¸
Cargo looks for build.rs in the root directory
        â¬‡ï¸
If found, it executes build.rs
        â¬‡ï¸
build.rs:
   - Lists .proto files to compile
   - Sets up protoc compiler (vendored)
   - Runs protobuf_codegen
        â¬‡ï¸
Protobuf Rust code is generated into:
   ğŸ“‚ $OUT_DIR/uprotocol
   ğŸ“‚ $OUT_DIR/cloudevents (if feature enabled)
        â¬‡ï¸
Rust code uses generated types at compile time
```
